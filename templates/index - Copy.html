<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Azentyk - AI-powered Doctor Appointment Assistant">
    <title>Azentyk | Doctor Appointment Assistant</title>
    <script>
        // Session ID injected by FastAPI template
        const sessionId = "{{ session_id }}";
    </script>
    <!-- Favicon -->
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Primary Colors */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-200: #bfdbfe;
            --primary-300: #93c5fd;
            --primary-400: #60a5fa;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;
            
            /* Neutral Colors */
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            
            /* Error Colors */
            --error-50: #fef2f2;
            --error-100: #fee2e2;
            --error-200: #fecaca;
            --error-300: #fca5a5;
            --error-400: #f87171;
            --error-500: #ef4444;
            --error-600: #dc2626;
            --error-700: #b91c1c;
            --error-800: #991b1b;
            --error-900: #7f1d1d;
            
            /* Success Colors */
            --success-50: #f0fdf4;
            --success-100: #dcfce7;
            --success-200: #bbf7d0;
            --success-300: #86efac;
            --success-400: #4ade80;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --success-700: #15803d;
            --success-800: #166534;
            --success-900: #14532d;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
            
            /* Transition */
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
            color: var(--neutral-800);
            background-color: var(--neutral-50);
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        /* Chat Container */
        .chat-app {
            width: 100%;
            max-width: 900px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--neutral-200);
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: white;
            border-bottom: 1px solid var(--neutral-200);
            z-index: 10;
        }

        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-600);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .app-title svg {
            width: 1.5rem;
            height: 1.5rem;
            color: var(--primary-600);
        }

        .auth-button {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid transparent;
        }

        .logout-button {
            background-color: var(--error-600);
            color: white;
        }

        .logout-button:hover {
            background-color: var(--error-700);
        }

        .login-button {
            background-color: var(--primary-600);
            color: white;
        }

        .login-button:hover {
            background-color: var(--primary-700);
        }

        /* Chat Box */
        .chat-box {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            background-color: var(--neutral-50);
        }

        /* Messages */
        .message-container {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            max-width: 85%;
            animation: fadeIn 0.3s forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .user-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .ai-message {
            align-self: flex-start;
        }

        .message-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-full);
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        .user-message .message-avatar {
            border-color: var(--primary-100);
        }

        .ai-message .message-avatar {
            border-color: var(--neutral-100);
        }

        .message-content {
            padding: 0.875rem 1.125rem;
            border-radius: var(--radius-lg);
            font-size: 0.9375rem;
            line-height: 1.6;
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
            max-width: 100%;
        }

        .user-message .message-content {
            background-color: var(--primary-600);
            color: white;
            border-bottom-right-radius: var(--radius-sm);
        }

        .ai-message .message-content {
            background-color: white;
            color: var(--neutral-800);
            border-bottom-left-radius: var(--radius-sm);
            border: 1px solid var(--neutral-200);
        }

        /* Message content styling for AI responses */
        .ai-message .message-content ul,
        .ai-message .message-content ol {
            margin: 0.5rem 0 0.5rem 1.25rem;
            padding-left: 0.5rem;
        }

        .ai-message .message-content li {
            margin-bottom: 0.25rem;
        }

        .ai-message .message-content p {
            margin-bottom: 0.75rem;
        }

        .ai-message .message-content p:last-child {
            margin-bottom: 0;
        }

        .ai-message .message-content strong {
            font-weight: 600;
            color: var(--neutral-900);
        }

        .ai-message .message-content em {
            font-style: italic;
        }

        /* Input Area */
        .input-area {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border-top: 1px solid var(--neutral-200);
            position: relative;
        }

        .message-input {
            flex: 1;
            padding: 0.875rem 1.125rem;
            font-size: 0.9375rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--neutral-200);
            background-color: var(--neutral-50);
            transition: var(--transition);
            outline: none;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
            font-family: 'Inter', sans-serif;
        }

        .message-input:focus {
            border-color: var(--primary-400);
            background-color: white;
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .action-button {
            width: 2.75rem;
            height: 2.75rem;
            border-radius: var(--radius-full);
            border: none;
            background-color: var(--primary-600);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            margin-left: 0.75rem;
            flex-shrink: 0;
        }

        .action-button:hover {
            background-color: var(--primary-700);
            transform: translateY(-1px);
        }

        .action-button:active {
            transform: translateY(0);
        }

        .action-button.secondary {
            background-color: white;
            color: var(--neutral-600);
            border: 1px solid var(--neutral-200);
        }

        .action-button.secondary:hover {
            background-color: var(--neutral-50);
            color: var(--neutral-700);
        }

        /* Voice Controls */
        .voice-controls {
            position: absolute;
            bottom: 5.5rem;
            right: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .voice-toggle {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            background-color: white;
            border: 1px solid var(--neutral-200);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .voice-toggle:hover {
            background-color: var(--neutral-50);
        }

        .voice-toggle.active {
            background-color: var(--primary-50);
            border-color: var(--primary-200);
            color: var(--primary-700);
        }

        /* Status Indicators */
        .status-indicator {
            font-size: 0.75rem;
            color: var(--neutral-500);
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            background-color: var(--neutral-100);
            align-self: center;
            margin: 0.5rem 0;
        }

        /* Typing indicator animation */
        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: var(--radius-full);
            background-color: var(--neutral-400);
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-0.25rem); }
        }

        /* Hidden Elements */
        .hidden {
            display: none;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--neutral-100);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--neutral-300);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--neutral-400);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .chat-app {
                height: 90vh;
                border-radius: 0;
            }

            .message-container {
                max-width: 90%;
            }

            .voice-controls {
                bottom: 6rem;
                right: 1rem;
            }
            
            .message-content {
                padding: 0.75rem 1rem;
            }
            
            .message-input {
                padding: 0.75rem 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Main Chat Application -->
    <div class="chat-app">
        <!-- Header with Title and Auth Button -->
        <header class="app-header">
            <h1 class="app-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.484 2.17a.75.75 0 011.032 0 11.209 11.209 0 007.877 3.08.75.75 0 01.722.515 12.74 12.74 0 01.635 3.985c0 5.942-4.064 10.933-9.563 12.348a.749.749 0 01-.374 0C6.314 20.683 2.25 15.692 2.25 9.75c0-1.39.223-2.73.635-3.985a.75.75 0 01.722-.516l.143.001c2.996 0 5.718-1.17 7.734-3.08zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zM12 15a.75.75 0 00-.75.75v.008c0 .414.336.75.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75H12z" clip-rule="evenodd" />
                </svg>
                Azentyk Doctor Assistant
            </h1>
            {% if request.session.get("user") %}
                <a href="/logout" class="auth-button logout-button" onclick="handleLogout()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Logout
                </a>
            {% else %}
                <a href="/login" class="auth-button login-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Login
                </a>
            {% endif %}
        </header>

        <!-- Hidden Initial Greeting -->
        <div id="initial-greeting" class="hidden">{{ greeting }}</div>

        <!-- Chat Messages Container -->
        <div class="chat-box" id="chat-box">
            <!-- Messages will be inserted here by JavaScript -->
        </div>

        <!-- Voice Controls -->
        <div class="voice-controls">
            <button id="toggle-voice" class="voice-toggle active" onclick="toggleVoice()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
                Voice On
            </button>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <textarea id="user-input" class="message-input" placeholder="Type your message here..." rows="1" onkeydown="handleKeyPress(event)"></textarea>
            <button class="action-button" onclick="sendMessage()" title="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
            <button class="action-button secondary" onclick="toggleMic()" id="micButton" title="Voice input">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const userInput = document.getElementById("user-input");
        const chatBox = document.getElementById("chat-box");
        const micButton = document.getElementById("micButton");
        const voiceToggle = document.getElementById("toggle-voice");

        // App State
        let voiceEnabled = true;
        let recognizing = false;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;

        // Initialize Speech Recognition
        if (recognition) {
            recognition.lang = "en-US";
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                recognizing = true;
                micButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="4"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12" y2="16"></line>
                    </svg>
                `;
                micButton.title = "Listening... Click to stop";
                micButton.classList.add("active");
            };

            recognition.onend = () => {
                recognizing = false;
                micButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                `;
                micButton.title = "Voice input";
                micButton.classList.remove("active");
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                if (transcript) {
                    // Stop any ongoing speech before processing new input
                    stopSpeaking();
                    appendMessage("user", transcript);
                    fetchBotResponse(transcript);
                }
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error", event.error);
                appendMessage("bot", "Sorry, I couldn't understand your voice input. Please try typing instead.");
            };
        } else {
            console.warn("Speech recognition not supported in this browser");
            micButton.style.display = "none";
        }

        // Message Functions
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Stop any ongoing speech before sending new message
            stopSpeaking();

            appendMessage("user", message);
            userInput.value = "";
            await fetchBotResponse(message);
        }

        async function fetchBotResponse(message) {
            try {
                showTypingIndicator();

                const response = await fetch(`/chat/${sessionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_input: message })
                });

                if (!response.ok) throw new Error("Network response was not ok");

                const data = await response.json();
                removeTypingIndicator();
                appendMessage("bot", formatBotResponse(data.response));
            } catch (error) {
                console.error("Error:", error);
                removeTypingIndicator();
                appendMessage("bot", "Sorry, I'm having trouble responding. Please try again later.");
            }
        }

        function formatBotResponse(text) {
            // Convert markdown-style lists to HTML lists
            let formattedText = text;
            
            // Convert unordered lists
            formattedText = formattedText.replace(/^\s*-\s(.+)$/gm, "<li>$1</li>");
            formattedText = formattedText.replace(/^\s*\*\s(.+)$/gm, "<li>$1</li>");
            
            // Convert ordered lists
            formattedText = formattedText.replace(/^\s*\d+\.\s(.+)$/gm, "<li>$1</li>");
            
            // Wrap consecutive list items in <ul> or <ol>
            formattedText = formattedText.replace(/(<li>.*<\/li>)+/g, function(match) {
                return `<ul>${match}</ul>`;
            });
            
            // Convert **bold** to <strong>
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
            
            // Convert *italic* to <em>
            formattedText = formattedText.replace(/\*(.*?)\*/g, "<em>$1</em>");
            
            // Convert line breaks to paragraphs
            formattedText = formattedText.split('\n\n').map(paragraph => {
                if (!paragraph.startsWith('<ul>') && !paragraph.startsWith('<li>')) {
                    return `<p>${paragraph}</p>`;
                }
                return paragraph;
            }).join('');
            
            return formattedText;
        }

        function appendMessage(sender, text) {
            const messageContainer = document.createElement("div");
            messageContainer.className = `message-container ${sender}-message`;

            const avatar = document.createElement("img");
            avatar.className = "message-avatar";
            avatar.src = sender === "user" ? "/static/men.jpg" : "/static/azentik.jpg";
            avatar.alt = sender === "user" ? "User avatar" : "Azentyk avatar";
            avatar.loading = "lazy";

            const content = document.createElement("div");
            content.className = "message-content";
            content.innerHTML = sender === "bot" ? text : escapeHtml(text);

            if (sender === "user") {
                messageContainer.appendChild(content);
                messageContainer.appendChild(avatar);
            } else {
                messageContainer.appendChild(avatar);
                messageContainer.appendChild(content);
                
                if (voiceEnabled) {
                    speakBotResponse(stripHtml(text));
                }
            }

            chatBox.appendChild(messageContainer);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const typingIndicator = document.createElement("div");
            typingIndicator.id = "typing-indicator";
            typingIndicator.className = "message-container ai-message";
            
            const avatar = document.createElement("img");
            avatar.className = "message-avatar";
            avatar.src = "/static/azentik.jpg";
            avatar.alt = "Azentyk avatar";
            avatar.loading = "lazy";
            
            const content = document.createElement("div");
            content.className = "message-content";
            content.innerHTML = '<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
            
            typingIndicator.appendChild(avatar);
            typingIndicator.appendChild(content);
            chatBox.appendChild(typingIndicator);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById("typing-indicator");
            if (indicator) indicator.remove();
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Voice Functions
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            voiceToggle.classList.toggle("active", voiceEnabled);
            voiceToggle.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
                ${voiceEnabled ? "Voice On" : "Voice Off"}
            `;
            
            if (!voiceEnabled) {
                stopSpeaking();
            }
        }

        function speakBotResponse(text) {
            if (!voiceEnabled || !text) return;
            
            if ('speechSynthesis' in window) {
                // Clean up text for speech (remove HTML tags, etc.)
                const cleanText = stripHtml(text)
                    .replace(/\*/g, '') // Remove markdown asterisks
                    .replace(/#/g, '') // Remove markdown headers
                    .replace(/\[(.*?)\]\(.*?\)/g, '$1'); // Remove markdown links
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'en-US';
                utterance.pitch = 1;
                utterance.rate = 0.9;
                utterance.volume = 1;
                
                // Cancel any ongoing speech before starting new one
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            }
        }

        function stopSpeaking() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }

        function toggleMic() {
            if (!recognition) {
                appendMessage("bot", "Voice input is not supported in your browser. Please use the text input.");
                return;
            }

            if (recognizing) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        // Logout handler
        function handleLogout() {
            // Stop any ongoing speech when logging out
            stopSpeaking();
            
            // If you need to perform any other cleanup before logout, do it here
            // The page will then proceed with the logout action
        }

        // Utility Functions
        function stripHtml(html) {
            const div = document.createElement("div");
            div.innerHTML = html;
            return div.textContent || div.innerText || "";
        }

        function escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        function handleKeyPress(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
            
            // Auto-resize textarea
            if (event.key === "Enter" || event.key === "Backspace") {
                userInput.style.height = "auto";
                userInput.style.height = (userInput.scrollHeight) + "px";
            }
        }

        // Initialize the app
        window.onload = function() {
            // Auto-focus input
            userInput.focus();
            
            // Auto-resize textarea
            userInput.addEventListener("input", function() {
                this.style.height = "auto";
                this.style.height = (this.scrollHeight) + "px";
            });

            // Show initial greeting if available
            const greetingDiv = document.getElementById("initial-greeting");
            const greetingText = greetingDiv.textContent.trim();
            
            if (greetingText) {
                setTimeout(() => {
                    appendMessage("bot", formatBotResponse(greetingText));
                }, 800);
            }
        };

        // Stop speaking when page is unloaded (including logout)
        window.addEventListener('beforeunload', function() {
            stopSpeaking();
        });
    </script>
</body>
</html>